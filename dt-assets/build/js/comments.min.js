jQuery(document).ready((function($){let commentPostedEvent=document.createEvent("Event");commentPostedEvent.initEvent("comment_posted",!0,!0);let postId=window.detailsSettings.post_id,postType=window.detailsSettings.post_type,rest_api=window.API,comments=[],activity=[],langcode=document.querySelector("html").getAttribute("lang")?document.querySelector("html").getAttribute("lang").replace("_","-"):"en";$(".show-tabs").on("click",(function(){let id=$(this).attr("id");$("input.tabs-section").prop("checked","show-all-tabs"===id),saveTabs()}));let commentTemplate=window.lodash.template(`\n  <div class="activity-block">\n    <div>\n        <span class="gravatar"><img src="<%- gravatar  %>"/></span>\n        <span><strong><%- name %></strong></span>\n        <span class="comment-date"> <%- date %> </span>\n      </div>\n    <div class="activity-text">\n    <% var is_Comment; var has_Comment_ID; %>\n    <% window.lodash.forEach(activity, function(a){\n        if (a.comment){ %>\n          <% is_Comment = true; %>\n            <div dir="auto" class="comment-bubble <%- a.comment_ID %>">\n              <div class="comment-text" title="<%- date %>" dir=auto><%= a.text.replace(/\\n/g, '</div><div class="comment-text" dir=auto>') /* not escaped on purpose */ %></div>\n            </div>\n            <% if ( commentsSettings.google_translate_key !== ""  && is_Comment && !has_Comment_ID && activity[0].comment_type !== 'duplicate' ) { %>\n              <div class="translation-bubble" dir=auto></div>\n            <% } %>\n            <p class="comment-controls">\n               <% if ( a.comment_ID ) { %>\n                <% has_Comment_ID = true %>\n                  <a class="open-edit-comment" data-id="<%- a.comment_ID %>" data-type="<%- a.comment_type %>" style="margin-right:5px">\n                      <img src="${commentsSettings.template_dir}/dt-assets/images/edit-blue.svg">\n                      ${window.lodash.escape(commentsSettings.translations.edit)}\n                  </a>\n                  <a class="open-delete-comment" data-id="<%- a.comment_ID %>">\n                      <img src="${commentsSettings.template_dir}/dt-assets/images/trash-blue.svg">\n                      ${window.lodash.escape(commentsSettings.translations.delete)}\n                  </a>\n               <% } %>\n            </p>\n        <% } else { %>\n            <p class="activity-bubble" title="<%- date %>">  <%- a.text %> <% print(a.action) %> </p>\n        <%  }\n    }); %>\n    <% if ( commentsSettings.google_translate_key !== ""  && is_Comment && !has_Comment_ID && activity[0].comment_type !== 'duplicate'\n    ) { %>\n        <a class="translate-button showTranslation">${window.lodash.escape(commentsSettings.translations.translate)}</a>\n        <a class="translate-button hideTranslation hide">${window.lodash.escape(commentsSettings.translations.hide_translation)}</a>\n        </div>\n    <% } %>\n    </div>\n  </div>`);function formatNumber(num,lang){return num.toLocaleString(lang)}function display_activity_comment(){let hiddenTabs=[];try{hiddenTabs=JSON.parse(window.SHAREDFUNCTIONS.getCookie("dt_activity_comments_hidden_tabs"))}catch(e){}hiddenTabs.forEach((tab=>{$(`#tab-button-${tab}`).prop("checked",!1)}));let commentsWrapper=$("#comments-wrapper");commentsWrapper.empty();let displayed=[];hiddenTabs.includes("activity")||(displayed=window.lodash.union(displayed,activity)),comments.forEach((comment=>{hiddenTabs.includes(comment.comment_type)||displayed.push(comment)})),displayed=window.lodash.orderBy(displayed,"date","desc");let array=[];displayed.forEach((d=>{let baptismDateRegex=/\{(\d+)\}+/;baptismDateRegex.test(d.object_note)&&(d.object_note=d.object_note.replace(baptismDateRegex,baptismTimestamptoDate));let first=window.lodash.first(array),name=d.comment_author||d.name,gravatar=d.gravatar||"",obj={name:name,date:d.date,gravatar:gravatar,text:d.object_note||formatComment(d.comment_content),comment:!!d.comment_content,comment_ID:d.user_id===commentsSettings.current_user_id&&d.comment_ID,comment_type:d.comment_type,action:d.action},diff=first?first.date.diff(obj.date,"hours"):0;!first||first.name===name&&diff<1?array.push(obj):(commentsWrapper.append(commentTemplate({name:array[0].name,gravatar:array[0].gravatar,date:window.SHAREDFUNCTIONS.formatDate(moment(array[0].date).unix(),!0),activity:array})),array=[obj])})),array.length>0&&commentsWrapper.append(commentTemplate({gravatar:array[0].gravatar,name:array[0].name,date:window.SHAREDFUNCTIONS.formatDate(moment(array[0].date).unix(),!0),activity:array}))}function baptismTimestamptoDate(match,timestamp){return window.SHAREDFUNCTIONS.formatDate(timestamp)}$(document).on("click",".translate-button.showTranslation",(function(){let combinedArray=[];jQuery(this).siblings(".comment-bubble").each((function(index,comment){let sourceText=$(comment).text();sourceText=sourceText.replace(/\s+/g," ").trim(),combinedArray[index]=sourceText}));let targetLang,translation_bubble=$(this).siblings(".translation-bubble"),translation_hide=$(this).siblings(".translate-button.hideTranslation"),url=`https://translation.googleapis.com/language/translate/v2?key=${window.lodash.escape(commentsSettings.google_translate_key)}`;function google_translate_fetch(postData,translate_button,arrayStartPos=0){fetch(url,{method:"POST",body:JSON.stringify(postData)}).then((response=>response.json())).then((result=>{$.each(result.data.translations,(function(index,translation){$(translation_bubble[index+arrayStartPos]).append(translation.translatedText)})),translation_hide.removeClass("hide"),$(translate_button).addClass("hide")}))}if(targetLang="zh-TW"!==langcode?langcode.substr(0,2):langcode,combinedArray.length<=128){google_translate_fetch({q:combinedArray,target:targetLang},this)}else{var i,j;for(i=0,j=combinedArray.length;i<j;i+=128){google_translate_fetch({q:combinedArray.slice(i,i+128),target:targetLang},this,i)}}})),$(document).on("click",".translate-button.hideTranslation",(function(){let translation_bubble=$(this).siblings(".translation-bubble"),translate_button=$(this).siblings(".translate-button.showTranslation");translation_bubble.empty(),$(this).addClass("hide"),translate_button.removeClass("hide")})),$(document).on("click",".open-delete-comment",(function(){let id=$(this).data("id");$("#comment-to-delete").html($(`.comment-bubble.${id}`).html()),$(".delete-comment.callout").hide(),$("#delete-comment-modal").foundation("open"),$("#confirm-comment-delete").data("id",id)})),$("#confirm-comment-delete").on("click",(function(){let id=$(this).data("id");$(this).toggleClass("loading"),rest_api.delete_comment(postType,postId,id).then((response=>{$(this).toggleClass("loading"),response?$("#delete-comment-modal").foundation("close"):$(".delete-comment.callout").show()})).catch((err=>{$(this).toggleClass("loading"),window.lodash.get(err,"responseJSON.message")&&($(".delete-comment.callout").show(),$("#delete-comment-error").html(err.responseJSON.message))}))})),$(document).on("click",".open-edit-comment",(function(){let id=$(this).data("id"),comment_type=$(this).data("type"),comment_html=window.lodash.find(comments,{comment_ID:id.toString()}).comment_content;$("#comment-to-edit").val(function unescapeHtml(safe){return safe.replace(/&amp;/g,"&").replace(/&quot;/g,'"').replace(/&#39;/g,"'").replace(/&#039;/g,"'")}(comment_html)),$("#edit_comment_type_selector").val(comment_type),$(".edit-comment.callout").hide(),$("#edit-comment-modal").foundation("open"),$("#confirm-comment-edit").data("id",id)})),$("#confirm-comment-edit").on("click",(function(){$(this).toggleClass("loading");let id=$(this).data("id"),updated_comment=$("#comment-to-edit").val(),commentType=$("#edit_comment_type_selector").val();rest_api.update_comment(postType,postId,id,updated_comment,commentType).then((response=>{$(this).toggleClass("loading"),1===response||0===response||response.comment_ID?$("#edit-comment-modal").foundation("close"):$(".edit-comment.callout").show()})).catch((err=>{$(this).toggleClass("loading"),window.lodash.get(err,"responseJSON.message")&&($(".edit-comment.callout").show(),$("#edit-comment-error").html(err.responseJSON.message))}))})),$(document).ajaxComplete((function(event,xhr,settings){settings&&settings.type&&("POST"===settings.type||"DELETE"===settings.type)&&(settings.url.includes("notifications")||refreshActivity())})),$(document).ajaxSend((function(event,xhr,settings){settings&&settings.type&&("POST"===settings.type||"DELETE"===settings.type)&&(settings.url.includes("notifications")||$("#comments-activity-spinner.loading-spinner").addClass("active"))}));let refreshActivity=()=>{!function get_all(){getAllPromise&&4!==window.lodash.get(getAllPromise,"readyState")&&(getActivityPromise.abort(),getCommentsPromise.abort());getCommentsPromise=rest_api.get_comments(postType,postId),getActivityPromise=rest_api.get_activity(postType,postId),getAllPromise=$.when(getCommentsPromise,getActivityPromise),getAllPromise.then((function(commentDataStatusJQXHR,activityDataStatusJQXHR){$("#comments-activity-spinner.loading-spinner").removeClass("active");const commentData=commentDataStatusJQXHR[0].comments,activityData=activityDataStatusJQXHR[0].activity;prepareData(commentData,activityData)})).catch((err=>{"abort"===!window.lodash.get(err,"statusText")&&(console.error(err),jQuery("#errors").append(err.responseText))}))}()},formatComment=comment=>{if(comment){let mentionRegex=/\@\[(.*?)\]\((.+?)\)/g,urlRegex=/((href=('|"))|(\[|\()?|(http(s)?:((\/)|(\\))*.))*(www\.)?[-a-zA-Z0-9@:%._\+~#=]{2,256}\.[a-z]{2,6}\b([-a-zA-Z0-9@:%_\+.~#?&//\\=]*)/g,linkRegex=/\[(.*?)\]\((.+?)\)/g;comment=(comment=(comment=comment.replace(mentionRegex,((match,text,id)=>`<a dir="auto">@${text}</a>`))).replace(urlRegex,(match=>{let url=match;return-1===match.indexOf("@")&&-1===match.indexOf("[")&&-1===match.indexOf("(")&&-1===match.indexOf("href")?(0===match.indexOf("http")&&-1===match.indexOf("www.")?url=match:-1===match.indexOf("http")&&0===match.indexOf("www.")?url="http://"+match:-1===match.indexOf("www.")&&(url="http://www."+match),`<a href="${url}" rel="noopener noreferrer" target="_blank">${match}</a>`):match}))).replace(linkRegex,((match,text,url)=>(text.includes("http")&&!url.includes("http")&&([url,text]=[text,url]),`<a href="${url=url.includes("http")?url:`${window.wpApiShare.site_url}/${window.wpApiShare.post_type}/${url}`}">${text}</a>`)))}return comment},getAllPromise=null,getCommentsPromise=null,getActivityPromise=null;let prepareData=function(commentData,activityData){let typesCount={};commentData.forEach((comment=>{comment.date=moment(comment.comment_date_gmt+"Z"),comment.comment_content=$("<div>").text(comment.comment_content).text(),typesCount[comment.comment_type]||(typesCount[comment.comment_type]=0),typesCount[comment.comment_type]++})),$("#comment-activity-tabs .tabs-title").addClass("hide"),window.lodash.forOwn(typesCount,((val,key)=>{let tab=$(`[data-id="${key}"].tab-button-label`),text=tab.text();text=text.substring(0,text.indexOf("("))||text,text+=` (${formatNumber(val,langcode)})`,tab.text(text),tab.parent().parent(".hide").removeClass("hide")})),comments=commentData,activity=activityData,function prepareActivityData(activityData){let settings=commentsSettings;const currentContact=settings.post;let createdDate=moment.utc(currentContact.post_date_gmt,"YYYY-MM-DD HH:mm:ss",!0);const createdContactActivityItem={hist_time:createdDate.unix(),object_note:settings.txt_created.replace("{}",window.SHAREDFUNCTIONS.formatDate(createdDate.unix())),name:settings.contact_author_name,user_id:currentContact.post_author};if(activityData.push(createdContactActivityItem),window.lodash.get(settings,"post_with_fields.initial_comments")){const initialComments={hist_time:createdDate.unix()+1,object_note:settings.post_with_fields.initial_comments,name:settings.contact_author_name,user_id:currentContact.post_author};activityData.push(initialComments)}activityData.forEach((item=>{item.date=moment.unix(item.hist_time);let field=item.meta_key;field&&field.includes("quick_button_")?(window.detailsSettings&&(field=window.lodash.get(window.detailsSettings,`post_fields[${item.meta_key}].name`)),item.action=`<a class="revert-activity dt_tooltip" data-id="${window.lodash.escape(item.histid)}">\n          <img class="revert-arrow-img" src="${commentsSettings.template_dir}/dt-assets/images/undo.svg">\n          <span class="tooltiptext">${window.lodash.escape(field||item.meta_key)} </span>\n        </a>`):item.action=""}));let tab=$('[data-id="activity"].tab-button-label'),text=tab.text();text=text.substring(0,text.indexOf("("))||text,text+=` (${formatNumber(activityData.length,langcode)})`,tab.text(text),tab.parent().parent(".hide").removeClass("hide")}(activity),display_activity_comment()};prepareData(commentsSettings.comments.comments,commentsSettings.activity.activity),jQuery("#add-comment-button").on("click",(function(){!function post_comment(postId){let commentInput=jQuery("#comment-input"),commentButton=jQuery("#add-comment-button"),commentType=$("#comment_type_selector").val();getCommentWithMentions((comment_plain_text=>{comment_plain_text&&(commentButton.toggleClass("loading"),commentInput.attr("disabled",!0),commentButton.attr("disabled",!0),rest_api.post_comment(postType,postId,comment_plain_text,commentType).then((data=>{let updated_comment=data.comment||data;commentInput.val("").trigger("change"),commentButton.toggleClass("loading"),updated_comment.date=moment(updated_comment.comment_date_gmt+"Z"),comments.push(updated_comment),display_activity_comment(),$("#content")[0].dispatchEvent(commentPostedEvent),commentInput.attr("disabled",!1),commentButton.attr("disabled",!1),$("textarea.mention").mentionsInput("reset")})).catch((err=>{console.log("error"),console.log(err),jQuery("#errors").append(err.responseText)})))}))}(postId)})),$("#comment-activity-tabs .tabs-section").on("change",(function(){saveTabs()}));let saveTabs=()=>{let hiddenTabs=$("#comment-activity-tabs .tabs-section:not(:checked)"),hiddenTabIds=[];hiddenTabs.each(((i,e)=>{hiddenTabIds.push($(e).data("id"))})),document.cookie=`dt_activity_comments_hidden_tabs=${JSON.stringify(hiddenTabIds)};path=/;expires=Fri, 31 Dec 9999 23:59:59 GMT"`,display_activity_comment()},searchUsersPromise=null;$("textarea.mention").mentionsInput({onDataRequest:function(mode,query,callback){$("#comment-input").addClass("loading-gif"),searchUsersPromise&&4!==window.lodash.get(searchUsersPromise,"readyState")&&searchUsersPromise.abort("abortPromise"),searchUsersPromise=API.search_users(query),searchUsersPromise.then((responseData=>{$("#comment-input").removeClass("loading-gif");let data=[];responseData.forEach((user=>{data.push({id:user.ID,name:user.name,type:postType,avatar:user.avatar}),callback.call(this,data)}))})).catch((err=>{console.error(err)}))},templates:{mentionItemSyntax:function(data){return`[${data.value}](${data.id})`}},showAvatars:!0,minChars:0});let getCommentWithMentions=callback=>{$("textarea.mention").mentionsInput("val",(function(text){callback(text)}))};$(document).on("click",".revert-activity",(function(){let id=$(this).data("id");$("#revert-modal").foundation("open"),$("#confirm-revert").data("id",id),API.get_single_activity(postType,postId,id).then((a=>{let field=a.meta_key;window.detailsSettings.post_settings&&(field=window.lodash.get(window.detailsSettings,`post_settings.fields[${a.meta_key}].name`)),$(".revert-field").html(field||a.meta_key),$(".revert-current-value").html(a.meta_value),$(".revert-old-value").html(a.old_value||0)})).catch((err=>{console.error(err)}))})),$("#confirm-revert").on("click",(function(){let id=$(this).data("id");API.revert_activity(postType,postId,id).then((contactResponse=>{refreshActivity(),$("#revert-modal").foundation("close"),"function"==typeof refresh_quick_action_buttons&&refresh_quick_action_buttons(contactResponse)})).catch((err=>{console.error(err)}))})),window.onbeforeunload=function(){if($("textarea.mention").val())return!0}}));
//# sourceMappingURL=comments.min.js.map
