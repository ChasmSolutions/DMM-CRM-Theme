'use strict';function _defineProperty(obj,key,value){if(key in obj){Object.defineProperty(obj,key,{value:value,enumerable:true,configurable:true,writable:true});}else{obj[key]=value;}return obj;}jQuery(document).ready(function(){window.current_user_lookup=wpApiSettingsPage.current_user_id;load_locations();});/**
 * Password reset
 *
 * @param preference_key
 * @param type
 * @returns {*}
 */function switch_preference(preference_key){var type=arguments.length>1&&arguments[1]!==undefined?arguments[1]:null;return makeRequest('post','users/switch_preference',{preference_key:preference_key,type:type});}function change_password(){var translation=wpApiSettingsPage.translations;// test matching passwords
var p1=jQuery('#password1');var p2=jQuery('#password2');var message=jQuery('#password-message');message.empty();if(p1.val()!==p2.val()){message.append(translation.pass_does_not_match);return;}makeRequest('post','users/change_password',{password:p1}).done(function(data){console.log(data);message.html(translation.changed);}).fail(handleAjaxError);}function load_locations(){makeRequest("GET",'user/my').done(function(data){if(typeof dtMapbox!=="undefined"){dtMapbox.post_type='user';write_results_box();}else{//locations
var typeahead=Typeahead['.js-typeahead-location_grid'];if(typeahead){typeahead.items=[];typeahead.comparedItems=[];typeahead.label.container.empty();typeahead.adjustInputSize();}if(typeof data.locations.location_grid!=="undefined"){data.locations.location_grid.forEach(function(location){typeahead.addMultiselectItemLayout({ID:location.id.toString(),name:location.label});});}}}).catch(function(e){console.log('error in locations');console.log(e);});}if(typeof dtMapbox==="undefined"){var typeaheadTotals={};if(!window.Typeahead['.js-typeahead-location_grid']){$.typeahead({input:'.js-typeahead-location_grid',minLength:0,accent:true,searchOnFocus:true,maxItem:20,dropdownFilter:[{key:'group',value:'focus',template:window.lodash.escape(window.wpApiShare.translations.regions_of_focus),all:window.lodash.escape(window.wpApiShare.translations.all_locations)}],source:{focus:{display:"name",ajax:{url:wpApiShare.root+'dt/v1/mapping_module/search_location_grid_by_name',data:{s:"{{query}}",filter:function filter(){return window.lodash.get(window.Typeahead['.js-typeahead-location_grid'].filters.dropdown,'value','all');}},beforeSend:function beforeSend(xhr){xhr.setRequestHeader('X-WP-Nonce',wpApiShare.nonce);},callback:{done:function done(data){if(typeof typeaheadTotals!=="undefined"){typeaheadTotals.field=data.total;}return data.location_grid;}}}}},display:"name",templateValue:"{{name}}",dynamic:true,multiselect:{matchOn:["ID"],data:function data(){return[];},callback:{onCancel:function onCancel(node,item){delete_location_grid(item.ID);}}},callback:{onClick:function onClick(node,a,item,event){add_location_grid(item.ID);},onReady:function onReady(){this.filters.dropdown={key:"group",value:"focus",template:window.lodash.escape(window.wpApiShare.translations.regions_of_focus)};this.container.removeClass("filter").find("."+this.options.selector.filterButton).html(window.lodash.escape(window.wpApiShare.translations.regions_of_focus));},onResult:function onResult(node,query,result,resultCount){resultCount=typeaheadTotals.location_grid;var text=TYPEAHEADS.typeaheadHelpText(resultCount,query,result);$('#location_grid-result-container').html(text);},onHideLayout:function onHideLayout(){$('#location_grid-result-container').html("");}}});}}var add_location_grid=function add_location_grid(value){var data={grid_id:value};return makeRequest("POST",'users/user_location',data);};var delete_location_grid=function delete_location_grid(value){var data={grid_id:value};return makeRequest("DELETE",'users/user_location',data);};var update_user=function update_user(key,value){var data=_defineProperty({},key,value);return makeRequest("POST",'user/update',data,'dt/v1/');};/**
 * Set availability dates
 */var dateFields=["start_date","end_date"];dateFields.forEach(function(key){var datePicker=$('#'+key+'.date-picker');datePicker.datepicker({onSelect:function onSelect(date){var start_date=$('#start_date').val();var end_date=$('#end_date').val();if(start_date&&end_date&&moment(start_date)<moment(end_date)){$('#add_unavailable_dates').removeAttr("disabled");}else{$('#add_unavailable_dates').attr("disabled",true);}},dateFormat:'yy-mm-dd',changeMonth:true,changeYear:true});});$('#add_unavailable_dates').on('click',function(){var start_date=$('#start_date').val();var end_date=$('#end_date').val();$('#add_unavailable_dates_spinner').addClass('active');update_user('add_unavailability',{start_date:start_date,end_date:end_date}).then(function(resp){$('#add_unavailable_dates_spinner').removeClass('active');$('#start_date').val('');$('#end_date').val('');display_dates_unavailable(resp);});});var display_dates_unavailable=function display_dates_unavailable(){var list=arguments.length>0&&arguments[0]!==undefined?arguments[0]:[];var first_run=arguments[1];var date_unavailable_table=$('#unavailable-list');var rows='';list=window.lodash.orderBy(list,["start_date"],"desc");list.forEach(function(range){rows+='<tr>\n        <td>'+window.lodash.escape(range.start_date)+'</td>\n        <td>'+window.lodash.escape(range.end_date)+'</td>\n        <td>\n            <button class="button hollow tiny alert remove_dates_unavailable" data-id="'+window.lodash.escape(range.id)+'" style="margin-bottom: 0">\n            <i class="fi-x"></i> '+window.lodash.escape(wpApiSettingsPage.translations.delete)+'</button>\n        </td>\n      </tr>';});if(rows||!rows&&!first_run){date_unavailable_table.html(rows);}};display_dates_unavailable(wpApiSettingsPage.custom_data.availability,true);$(document).on('click','.remove_dates_unavailable',function(){var id=$(this).data('id');update_user('remove_unavailability',id).then(function(resp){display_dates_unavailable(resp);});});var status_buttons=$('.status-button');var color_workload_buttons=function color_workload_buttons(name){status_buttons.css('background-color',"");status_buttons.addClass("hollow");if(name){var selected=$('.status-button[name='+name+']');selected.removeClass("hollow");selected.css('background-color',window.lodash.get(wpApiSettingsPage,'workload_status_options.'+name+'.color'));selected.blur();}};color_workload_buttons(wpApiSettingsPage.workload_status);status_buttons.on('click',function(){$("#workload-spinner").addClass("active");var name=$(this).attr('name');color_workload_buttons(name);update_user('workload_status',name).then(function(){$("#workload-spinner").removeClass("active");}).fail(function(){status_buttons.css('background-color',"");$("#workload-spinner").removeClass("active");status_buttons.addClass("hollow");});});$('button.dt_multi_select').on('click',function(){var fieldKey=$(this).data("field-key");var optionKey=$(this).attr('id');$('#'+fieldKey+'-spinner').addClass("active");var field=jQuery('[data-field-key="'+fieldKey+'"]#'+optionKey);field.addClass("submitting-select-button");var action="add";var update_request=null;if(field.hasClass("selected-select-button")){action="delete";update_request=update_user('remove_'+fieldKey,optionKey);}else{field.removeClass("empty-select-button");field.addClass("selected-select-button");update_request=update_user('add_'+fieldKey,optionKey);}update_request.then(function(){field.removeClass("submitting-select-button selected-select-button");field.blur();field.addClass(action==="delete"?"empty-select-button":"selected-select-button");$('#'+fieldKey+'-spinner').removeClass("active");}).catch(function(err){field.removeClass("submitting-select-button selected-select-button");field.addClass(action==="add"?"empty-select-button":"selected-select-button");handleAjaxError(err);});});$('select.select-field').change(function(e){var id=$(e.currentTarget).attr('id');var val=$(e.currentTarget).val();$('#'+id+'-spinner').addClass("active");update_user(id,val).then(function(){$('#'+id+'-spinner').removeClass("active");}).catch(handleAjaxError);});/**
 * People groups
 */$.typeahead({input:'.js-typeahead-people_groups',minLength:0,accent:true,searchOnFocus:true,maxItem:20,source:TYPEAHEADS.typeaheadPeopleGroupSource('people_groups','dt/v1/people-groups/compact/'),display:["name","label"],templateValue:"{{name}}",dynamic:true,multiselect:{matchOn:["ID"],data:function data(){return wpApiSettingsPage.user_people_groups.map(function(g){return{ID:g.ID,name:g.post_title};});},callback:{onCancel:function onCancel(node,item){update_user('remove_people_groups',item.ID);}}},callback:{onClick:function onClick(node,a,item,event){update_user('add_people_groups',item.ID);this.addMultiselectItemLayout(item);event.preventDefault();this.hideLayout();this.resetInput();},onResult:function onResult(node,query,result,resultCount){var text=TYPEAHEADS.typeaheadHelpText(resultCount,query,result);$('#people_groups-result-container').html(text);},onHideLayout:function onHideLayout(){$('#people_groups-result-container').html("");}}});