"use strict";!function($,list_settings,Foundation){let cached_filter,selected_filters=$("#selected-filters"),new_filter_labels=[],custom_filters=[],filter_to_save="",filter_to_delete="",filterToEdit="",filter_accordions=$("#list-filter-tabs"),currentFilters=$("#current-filters"),cookie=window.SHAREDFUNCTIONS.getCookie("last_view"),get_records_promise=null,loading_spinner=$("#list-loading-spinner"),old_filters=JSON.stringify(list_settings.filters),table_header_row=$(".js-list thead .sortable th"),fields_to_show_in_table=window.SHAREDFUNCTIONS.get_json_cookie("fields_to_show_in_table",[]),current_user_id=(window.SHAREDFUNCTIONS.get_json_cookie("fields_to_search",[]),wpApiNotifications.current_user_id),items=[];try{cached_filter=JSON.parse(cookie)}catch(e){cached_filter={}}let current_filter=cached_filter&&!window.lodash.isEmpty(cached_filter)?cached_filter:{query:{}};setup_filters();let check_first_filter=function(){$("#list-filter-tabs .accordion-item a")[0].click(),$($(".js-list-view")[0]).prop("checked",!0)};if(cached_filter&&!window.lodash.isEmpty(cached_filter)&&"custom_filter"===cached_filter.type)cached_filter.query.offset=0,add_custom_filter(cached_filter.name,"default",cached_filter.query,cached_filter.labels,!1);else if(current_filter.ID){$(`#list-filter-tabs [data-id='${window.lodash.escape(current_filter.tab)}'] a`).click();let filter_element=$(`input[name=view][data-id="${window.lodash.escape(current_filter.ID)}"].js-list-view`);filter_element.length?filter_element.prop("checked",!0):check_first_filter()}else check_first_filter();function get_records_for_current_filter(){let checked=$(".js-list-view:checked"),current_view=checked.val(),filter_id=checked.data("id")||current_view||"",sort=current_filter.query.sort||null;if("custom_filter"===current_view){let filterId=checked.data("id");current_filter=window.lodash.find(custom_filters,{ID:filterId}),current_filter.type=current_view}else current_filter=window.lodash.find(list_settings.filters.filters,{ID:filter_id})||window.lodash.find(list_settings.filters.filters,{ID:filter_id.toString()})||current_filter,current_filter.type="default",current_filter.labels=current_filter.labels||[{id:filter_id,name:current_filter.name}];sort=sort||current_filter.query.sort,current_filter.query.sort="string"==typeof sort?sort:"name",get_records()}function setup_filters(){if(!list_settings.filters.tabs)return;let selected_tab=$(".accordion-item.is-active").data("id"),selected_filter=$(".js-list-view:checked").data("id"),html="";list_settings.filters.tabs.forEach((tab=>{html+=`\n      <li class="accordion-item" data-accordion-item data-id="${window.lodash.escape(tab.key)}">\n        <a href="#" class="accordion-title" data-id="${window.lodash.escape(tab.key)}">\n          ${window.lodash.escape(tab.label)}\n          <span class="tab-count-span" data-tab="${window.lodash.escape(tab.key)}">\n              ${tab.count||tab.count>=0?`(${window.lodash.escape(tab.count)})`:""}\n          </span>\n        </a>\n        <div class="accordion-content" data-tab-content>\n          <div class="list-views">\n            ${list_settings.filters.filters.map((filter=>{if(filter.tab===tab.key&&"custom"!==filter.tab){let indent=filter.subfilter&&Number.isInteger(filter.subfilter)?15*filter.subfilter:15;return`\n                  <label class="list-view" style="${filter.subfilter?`margin-left:${indent}px`:""}">\n                    <input type="radio" name="view" value="${window.lodash.escape(filter.ID)}" data-id="${window.lodash.escape(filter.ID)}" class="js-list-view" autocomplete="off">\n                    <span id="total_filter_label">${window.lodash.escape(filter.name)}</span>\n                    <span class="list-view__count js-list-view-count" data-value="${window.lodash.escape(filter.ID)}">${window.lodash.escape(filter.count)}</span>\n                  </label>\n                  `}})).join("")}\n          </div>\n        </div>\n      </li>\n      `})),filter_accordions.html(html);let saved_filters_list=$("#list-filter-tabs [data-id='custom'] .list-views");saved_filters_list.empty(),0===list_settings.filters.filters.filter((t=>"custom"===t.tab)).length&&saved_filters_list.html(`<span>${window.lodash.escape(list_settings.translations.empty_custom_filters)}</span>`),list_settings.filters.filters.filter((t=>"custom"===t.tab)).forEach((filter=>{if(filter&&""===filter.visible)return;let delete_filter=$(`<span style="float:right" data-filter="${window.lodash.escape(filter.ID)}">\n        <img style="padding: 0 4px" src="${window.wpApiShare.template_dir}/dt-assets/images/trash.svg">\n      </span>`);delete_filter.on("click",(function(){$(".delete-filter-name").html(filter.name),$("#delete-filter-modal").foundation("open"),filter_to_delete=filter.ID}));let edit_filter=$(`<span style="float:right" data-filter="${window.lodash.escape(filter.ID)}">\n          <img style="padding: 0 4px" src="${window.wpApiShare.template_dir}/dt-assets/images/edit.svg">\n      </span>`);edit_filter.on("click",(function(){edit_saved_filter(filter),filterToEdit=filter.ID}));let filterName=`<span class="filter-list-name" data-filter="${window.lodash.escape(filter.ID)}">${window.lodash.escape(filter.name)}</span>`;const radio=$(`<input name='view' class='js-list-view' autocomplete='off' data-id="${window.lodash.escape(filter.ID)}" >`).attr("type","radio").val("saved-filters").on("change",(function(){}));saved_filters_list.append($("<div>").append($("<label>").css("cursor","pointer").addClass("js-filter-checkbox-label").data("filter-value",status).append(radio).append(filterName).append(delete_filter).append(edit_filter)))})),new Foundation.Accordion(filter_accordions,{slideSpeed:100,allowAllClosed:!0}),selected_tab&&$(`#list-filter-tabs [data-id='${window.lodash.escape(selected_tab)}'] a`).click(),selected_filter&&$(`[data-id="${window.lodash.escape(selected_filter)}"].js-list-view`).prop("checked",!0)}window.lodash.isEmpty(fields_to_show_in_table)&&(window.lodash.forOwn(list_settings.post_type_settings.fields,((field_settings,field_key)=>{(!0===window.lodash.get(field_settings,"show_in_table")||window.lodash.get(field_settings,"show_in_table")>0)&&fields_to_show_in_table.push(field_key)})),fields_to_show_in_table.sort(((a,b)=>(list_settings.post_type_settings.fields[a].show_in_table?!0===list_settings.post_type_settings.fields[a].show_in_table?50:list_settings.post_type_settings.fields[a].show_in_table:200)>(list_settings.post_type_settings.fields[b].show_in_table?!0===list_settings.post_type_settings.fields[b].show_in_table?50:list_settings.post_type_settings.fields[b].show_in_table:200)?1:-1))),get_records_for_current_filter(),$(document).on("change",".js-list-view",(()=>{get_records_for_current_filter()})),$(document).on("click",".accordion-title",(function(){let selected_filter=$(".js-list-view:checked").data("id"),tab=$(this).data("id");selected_filter&&($(`.accordion-item[data-id='${tab}'] .js-list-view`).first().prop("checked",!0),get_records_for_current_filter())}));let getFilterCountsPromise=null;getFilterCountsPromise&&4!==window.lodash.get(getFilterCountsPromise,"readyState")&&getFilterCountsPromise.abort(),getFilterCountsPromise=$.ajax({url:`${window.wpApiShare.root}dt/v1/users/get_filters?post_type=${list_settings.post_type}&force_refresh=1`,beforeSend:function(xhr){xhr.setRequestHeader("X-WP-Nonce",window.wpApiShare.nonce)}}),getFilterCountsPromise.then((filters=>{old_filters!==JSON.stringify(filters)&&(list_settings.filters=filters,setup_filters())})).catch((err=>{"abort"!==window.lodash.get(err,"statusText")&&console.error(err)}));let sort_field=window.lodash.get(current_filter,"query.sort","name");table_header_row.removeClass("sorting_asc"),table_header_row.removeClass("sorting_desc");let header_cell=$(`.js-list thead .sortable th[data-id="${window.lodash.escape(sort_field.replace("-",""))}"]`);header_cell.addClass("sorting_"+(sort_field.startsWith("-")?"desc":"asc")),table_header_row.data("sort",""),header_cell.data("sort","asc"),$(".js-sort-by").on("click",(function(){table_header_row.removeClass("sorting_asc"),table_header_row.removeClass("sorting_desc"),get_records(0,("asc"===$(this).data("order")?"":"-")+$(this).data("field"))})),$(".js-list th").on("click",(function(){if("bulk_edit_master"==this.id)return;let id=$(this).data("id"),sort=$(this).data("sort");table_header_row.removeClass("sorting_asc"),table_header_row.removeClass("sorting_desc"),table_header_row.data("sort",""),sort&&"desc"!==sort?($(this).data("sort","desc"),$(this).removeClass("sorting_asc"),$(this).addClass("sorting_desc"),id=`-${id}`):($(this).data("sort","asc"),$(this).addClass("sorting_asc"),$(this).removeClass("sorting_desc")),get_records(0,id)})),$("#choose_fields_to_show_in_table").on("click",(function(){$("#list_column_picker").toggle()})),$("#save_column_choices").on("click",(function(){let new_selected=[];$("#list_column_picker input:checked").each(((index,elem)=>{new_selected.push($(elem).val())})),fields_to_show_in_table=window.lodash.intersection(fields_to_show_in_table,new_selected),fields_to_show_in_table=window.lodash.uniq(window.lodash.union(fields_to_show_in_table,new_selected)),window.SHAREDFUNCTIONS.save_json_cookie("fields_to_show_in_table",fields_to_show_in_table,list_settings.post_type),window.location.reload()})),$("#reset_column_choices").on("click",(function(){fields_to_show_in_table=[],window.SHAREDFUNCTIONS.save_json_cookie("fields_to_show_in_table",fields_to_show_in_table,list_settings.post_type),window.location.reload()})),$("#records-table").dragableColumns({drag:!0,dragClass:"drag",overClass:"over",movedContainerSelector:".dnd-moved",onDragEnd:()=>{fields_to_show_in_table=[],$(".table-headers th").each(((i,e)=>{let field=$(e).data("id");field&&fields_to_show_in_table.push(field)})),window.SHAREDFUNCTIONS.save_json_cookie("fields_to_show_in_table",fields_to_show_in_table,list_settings.post_type)}}).on("click","tbody tr",(function(event){event.target.href||(window.location=$(this).data("link"))}));let build_table=records=>{let table_rows="",mobile=$(window).width()<1024;records.forEach(((record,index)=>{let row_fields_html="";fields_to_show_in_table.forEach((field_key=>{let values_html="",values=[];if("name"===field_key){if(mobile)return;values_html=`<a href="${window.lodash.escape(record.permalink)}" title="${window.lodash.escape(record.post_title)}">${window.lodash.escape(record.post_title)}</a>`}else{if(!list_settings.post_type_settings.fields[field_key])return;{let field_settings=list_settings.post_type_settings.fields[field_key],field_value=window.lodash.get(record,field_key,!1);field_value&&(["text","number"].includes(field_settings.type)?values=[window.lodash.escape(field_value)]:"date"===field_settings.type?values=[window.lodash.escape(window.SHAREDFUNCTIONS.formatDate(field_value.timestamp))]:"user_select"===field_settings.type?values=[window.lodash.escape(field_value.display)]:"key_select"===field_settings.type?values=[window.lodash.escape(field_value.label)]:"multi_select"===field_settings.type?values=field_value.map((v=>`${window.lodash.escape(window.lodash.get(field_settings,`default[${v}].label`,v))}`)):"location"===field_settings.type?values=field_value.map((v=>`${window.lodash.escape(v.label)}`)):"communication_channel"===field_settings.type?values=field_value.map((v=>`${window.lodash.escape(v.value)}`)):"connection"===field_settings.type?values=field_value.map((v=>`${window.lodash.escape(v.post_title)}`)):"boolean"===field_settings.type&&(values=["&check;"]))}}values_html+=values.map((v=>`<li>${v}</li>`)).join(""),$(window).width()<1024?row_fields_html+=`\n            <td>\n              <div class="mobile-list-field-name">\n                <ul>\n                ${window.lodash.escape(window.lodash.get(list_settings,`post_type_settings.fields[${field_key}].name`,field_key))}\n                </ul>\n              </div>\n              <div class="mobile-list-field-value">\n                <ul style="line-height:20px" >\n                  ${values.join(", ")}\n                </ul>\n              </div>\n\n            </td>\n          `:row_fields_html+=`\n            <td title="${values.join(", ")}">\n              <ul>\n                ${values_html}\n              </ul>\n            </td>\n          `})),table_rows+=mobile?`<tr data-link="${window.lodash.escape(record.permalink)}">\n          <td class="bulk_edit_checkbox">\n              <input class="bulk_edit_checkbox" type="checkbox" name="bulk_edit_id" value="${record.ID}">\n          </td>\n          <td>\n              <div class="mobile-list-field-name">\n                ${index+1}.\n              </div>\n              <div class="mobile-list-field-value">\n                  <a href="${window.lodash.escape(record.permalink)}">${window.lodash.escape(record.post_title)}</a>\n              </div>\n          </td>\n          ${row_fields_html}\n        `:`<tr class="dnd-moved" data-link="${window.lodash.escape(record.permalink)}">\n          <td class="bulk_edit_checkbox" ><input type="checkbox" name="bulk_edit_id" value="${record.ID}"></td>\n          <td style="white-space: nowrap" >${index+1}.</td>\n          ${row_fields_html}\n        `})),0===records.length&&(table_rows=`<tr><td colspan="10">${window.lodash.escape(list_settings.translations.empty_list)}</td></tr>`);let table_html=`\n      ${table_rows}\n    `;$("#table-content").html(table_html),function bulk_edit_checkbox_event(){$("tbody tr td.bulk_edit_checkbox").on("click",(function(e){e.stopImmediatePropagation(),bulk_edit_count()}))}()};function get_records(offset=0,sort=null){loading_spinner.addClass("active");let query=current_filter.query;offset&&(query.offset=offset),sort&&(query.sort=sort,query.offset=0),window.SHAREDFUNCTIONS.save_json_cookie("last_view",current_filter,list_settings.post_type),get_records_promise&&4!==window.lodash.get(get_records_promise,"readyState")&&get_records_promise.abort(),query.fields_to_return=fields_to_show_in_table,get_records_promise=window.makeRequestOnPosts("GET",`${list_settings.post_type}`,JSON.parse(JSON.stringify(query))),get_records_promise.then((response=>{items=offset?window.lodash.unionBy(items,response.posts||[],"ID"):response.posts||[],window.records_list=response,$("#bulk_edit_master_checkbox").prop("checked",!1),$("#load-more").toggle(items.length!==parseInt(response.total));let result_text=list_settings.translations.txt_info.replace("_START_",items.length).replace("_TOTAL_",response.total);$(".filter-result-text").html(result_text),build_table(items),function setup_current_filter_labels(){let html="",filter=current_filter;if(filter&&filter.labels)filter.labels.forEach((label=>{html+=`<span class="current-filter ${window.lodash.escape(label.field)}">${window.lodash.escape(label.name)}</span>`}));else{let query=filter.query;window.lodash.forOwn(query,(query_key=>{Array.isArray(query[query_key])?query[query_key].forEach((q=>{html+=`<span class="current-filter ${window.lodash.escape(query_key)}">${window.lodash.escape(q)}</span>`})):html+=`<span class="current-filter search">${window.lodash.escape(query[query_key])}</span>`}))}if(filter.query.sort){let sortLabel=filter.query.sort;sortLabel=sortLabel.includes("last_modified")?list_settings.translations.date_modified:sortLabel.includes("post_date")?list_settings.translations.creation_date:window.lodash.get(list_settings,`post_type_settings.fields[${filter.query.sort}].name`,sortLabel),html+=`<span class="current-filter" data-id="sort">\n          ${window.lodash.escape(list_settings.translations.sorting_by)}: ${window.lodash.escape(sortLabel)}\n      </span>`}currentFilters.html(html)}(),loading_spinner.removeClass("active")})).catch((err=>{loading_spinner.removeClass("active"),"abort"!==window.lodash.get(err,"statusText")&&console.error(err)}))}function add_custom_filter(name,type,query,labels,load_records=!0){query=query||current_filter.query;let ID=(new Date).getTime()/1e3;current_filter={ID:ID,type:type,name:window.lodash.escape(name),query:JSON.parse(JSON.stringify(query)),labels:labels},custom_filters.push(JSON.parse(JSON.stringify(current_filter)));let save_filter=$(`<a style="float:right" data-filter="${window.lodash.escape(ID.toString())}">\n        ${window.lodash.escape(list_settings.translations.save)}\n    </a>`).on("click",(function(){$("#filter-name").val(name),$("#save-filter-modal").foundation("open"),filter_to_save=ID})),filterRow=$(`<label class='list-view ${window.lodash.escape(ID.toString())}'>`).append(`\n      <input type="radio" name="view" value="custom_filter" data-id="${window.lodash.escape(ID.toString())}" class="js-list-view" checked autocomplete="off">\n        ${window.lodash.escape(name)}\n    `).append(save_filter);$(".custom-filters").append(filterRow),load_records&&get_records_for_current_filter()}$("#load-more").on("click",(function(){get_records(items.length)}));let get_custom_filter_search_query=()=>{let search_query=[];if(window.lodash.uniq(new_filter_labels.map((f=>f.field))).forEach((field=>{let type=window.lodash.get(list_settings,`post_type_settings.fields.${field}.type`);if("connection"!==type&&"user_select"!==type||search_query.push({[field]:window.lodash.map(window.lodash.get(Typeahead[`.js-typeahead-${field}`],"items"),"ID")}),"multi_select"===type&&search_query.push({[field]:window.lodash.map(window.lodash.get(Typeahead[`.js-typeahead-${field}`],"items"),"key")}),"location"===type)search_query.push({[field]:window.lodash.map(window.lodash.get(Typeahead[`.js-typeahead-${field}`],"items"),"ID")});else if("date"===type){let date={},start=$(`.dt_date_picker[data-field="${field}"][data-delimit="start"]`).val();start&&(date.start=start);let end=$(`.dt_date_picker[data-field="${field}"][data-delimit="end"]`).val();end&&(date.end=end),search_query.push({[field]:date})}else{let options=[];$(`#${field}-options input:checked`).each((function(){options.push($(this).val())})),options.length&&search_query.push({[field]:options})}})),search_query={fields:search_query},"contacts"===list_settings.post_type&&$("#combine_subassigned").is(":checked")){let assigned_to=search_query.fields.filter((a=>a.assigned_to)),subassigned=search_query.fields.filter((a=>a.subassigned));search_query.fields=search_query.fields.filter((a=>!a.assigned_to&&!a.subassigned)),search_query.fields.push([assigned_to[0],subassigned[0]]),search_query.combine=["subassigned"]}return search_query};$("#confirm-filter-records").on("click",(function(){let search_query=get_custom_filter_search_query();add_custom_filter(window.lodash.escape($("#new-filter-name").val())||"Custom Filter","custom-filter",search_query,new_filter_labels)}));$("#mapbox-clear-autocomplete").click("input",(function(){delete window.location_data}));let loadLocationTypeahead=()=>{window.Typeahead[".js-typeahead-location_grid"]||$.typeahead({input:".js-typeahead-location_grid",minLength:0,accent:!0,searchOnFocus:!0,maxItem:20,dropdownFilter:[{key:"group",value:"used",template:window.lodash.escape(window.wpApiShare.translations.used_locations),all:window.lodash.escape(window.wpApiShare.translations.all_locations)}],source:{used:{display:"name",ajax:{url:window.wpApiShare.root+"dt/v1/mapping_module/search_location_grid_by_name",data:{s:"{{query}}",filter:function(){return window.lodash.get(window.Typeahead[".js-typeahead-location_grid"].filters.dropdown,"value","all")}},beforeSend:function(xhr){xhr.setRequestHeader("X-WP-Nonce",window.wpApiShare.nonce)},callback:{done:function(data){return"undefined"!=typeof typeaheadTotals&&(typeaheadTotals.field=data.total),data.location_grid}}}}},display:"name",templateValue:"{{name}}",dynamic:!0,multiselect:{matchOn:["ID"],data:[],callback:{onCancel:function(node,item){$(`.current-filter[data-id="${item.ID}"].location_grid`).remove(),window.lodash.pullAllBy(new_filter_labels,[{id:item.ID}],"id")}}},callback:{onResult:function(node,query,result,resultCount){let text=TYPEAHEADS.typeaheadHelpText(resultCount,query,result);$("#location_grid-result-container").html(text)},onReady(){this.filters.dropdown={key:"group",value:"used",template:"Used Locations"},this.container.removeClass("filter").find("."+this.options.selector.filterButton).html("Used Locations")},onHideLayout:function(){$("#location_grid-result-container").html("")},onClick:function(node,a,item){let name=window.lodash.get(list_settings,"post_type_settings.fields.location_grid.name","location_grid");new_filter_labels.push({id:item.ID,name:`${name}: ${item.name}`,field:"location_grid"}),selected_filters.append(`<span class="current-filter location_grid" data-id="${window.lodash.escape(item.ID)}">${window.lodash.escape(name)}:${window.lodash.escape(item.name)}</span>`)}}})},typeaheads_loaded=null;$("#filter-modal").on("open.zf.reveal",(function(){new_filter_labels=[],loadLocationTypeahead(),$(".typeahead__query [data-type='connection']").each(((key,el)=>{let field_key=$(el).data("field"),post_type=window.lodash.get(list_settings,`post_type_settings.fields.${field_key}.post_type`,field_key);window.Typeahead[`.js-typeahead-${field_key}`]||$.typeahead({input:`.js-typeahead-${field_key}`,minLength:0,accent:!0,searchOnFocus:!0,maxItem:20,template:function(query,item){return`<span dir="auto">${window.lodash.escape(item.name)} (#${window.lodash.escape(item.ID)})</span>`},source:TYPEAHEADS.typeaheadPostsSource(post_type),display:"name",templateValue:"{{name}}",dynamic:!0,multiselect:{matchOn:["ID"],data:[],callback:{onCancel:function(node,item){$(`.current-filter[data-id="${item.ID}"].${field_key}`).remove(),window.lodash.pullAllBy(new_filter_labels,[{id:item.ID}],"id")}}},callback:{onResult:function(node,query,result,resultCount){let text=TYPEAHEADS.typeaheadHelpText(resultCount,query,result);$(`#${field_key}-result-container`).html(text)},onHideLayout:function(){$(`#${field_key}-result-container`).html("")},onClick:function(node,a,item){new_filter_labels.push({id:item.ID,name:item.name,field:field_key}),selected_filters.append(`<span class="current-filter ${field_key}" data-id="${window.lodash.escape(item.ID)}">${window.lodash.escape(item.name)}</span>`)}}})})),$(".typeahead__query [data-type='user_select']").each(((key,el)=>{let field_key=$(el).data("field");window.Typeahead[`.js-typeahead-${field_key}`]||$.typeahead({input:`.js-typeahead-${field_key}`,minLength:0,accent:!0,searchOnFocus:!0,maxItem:20,template:function(query,item){return`<span dir="auto">${window.lodash.escape(item.name)} (#${window.lodash.escape(item.ID)})</span>`},source:TYPEAHEADS.typeaheadUserSource(),display:"name",templateValue:"{{name}}",dynamic:!0,multiselect:{matchOn:["ID"],data:[],callback:{onCancel:function(node,item){$(`.current-filter[data-id="${item.ID}"].${field_key}`).remove(),window.lodash.pullAllBy(new_filter_labels,[{id:item.ID}],"id")}}},callback:{onResult:function(node,query,result,resultCount){let text=TYPEAHEADS.typeaheadHelpText(resultCount,query,result);$(`#${field_key}-result-container`).html(text)},onHideLayout:function(){$(`#${field_key}-result-container`).html("")},onClick:function(node,a,item){new_filter_labels.push({id:item.ID,name:item.name,field:field_key}),selected_filters.append(`<span class="current-filter ${field_key}" data-id="${window.lodash.escape(item.ID)}">${window.lodash.escape(item.name)}</span>`)}}})})),typeaheads_loaded=async function load_multi_select_typeaheads(){for(let input of $(".multi_select .typeahead__query input")){let field=$(input).data("field"),typeahead_name=`.js-typeahead-${field}`;if(window.Typeahead[typeahead_name])return;let source_data={data:[]},field_options=window.lodash.get(list_settings,`post_type_settings.fields.${field}.default`,{});Object.keys(field_options).length>0?window.lodash.forOwn(field_options,((val,key)=>{val.deleted||source_data.data.push({key:key,name:key,value:val.label||key})})):source_data={[field]:{display:["value"],ajax:{url:window.wpApiShare.root+`dt-posts/v2/${list_settings.post_type}/multi-select-values`,data:{s:"{{query}}",field:field},beforeSend:function(xhr){xhr.setRequestHeader("X-WP-Nonce",window.wpApiShare.nonce)},callback:{done:function(data){return(data||[]).map((tag=>({value:window.lodash.get(field_options,tag+".label",tag),key:tag})))}}}}},$.typeahead({input:`.js-typeahead-${field}`,minLength:0,maxItem:20,searchOnFocus:!0,template:function(query,item){return`<span>${window.lodash.escape(item.value)}</span>`},source:source_data,display:"value",templateValue:"{{value}}",dynamic:!0,multiselect:{matchOn:["key"],data:[],callback:{onCancel:function(node,item){$(`.current-filter[data-id="${item.key}"].${field}`).remove(),window.lodash.pullAllBy(new_filter_labels,[{id:item.key}],"id")}}},callback:{onClick:function(node,a,item){let name=window.lodash.get(list_settings,`post_type_settings.fields.${field}.name`,field);selected_filters.append(`<span class="current-filter ${window.lodash.escape(field)}" data-id="${window.lodash.escape(item.key)}">${window.lodash.escape(name)}:${window.lodash.escape(item.value)}</span>`),new_filter_labels.push({id:item.key,name:`${name}: ${item.value}`,field:field})},onResult:function(node,query,result,resultCount){let text=TYPEAHEADS.typeaheadHelpText(resultCount,query,result);$(`#${field}-result-container`).html(text)},onHideLayout:function(){$(`#${field}-result-container`).html("")}}})}}().catch((err=>{console.error(err)})),$("#new-filter-name").val(""),$("#filter-modal input.dt_date_picker").each((function(){$(this).val("")})),$("#filter-modal input:checked").each((function(){$(this).prop("checked",!1)})),selected_filters.empty(),$(".typeahead__query input").each((function(){let typeahead=Typeahead["."+$(this).attr("class").split(/\s+/)[0]];if(typeahead&&typeahead.items){for(let i=0;i<typeahead.items.length;i)typeahead.cancelMultiselectItem(0);typeahead.node.trigger("propertychange.typeahead")}})),$("#confirm-filter-records").show(),$("#save-filter-edits").hide()}));let edit_saved_filter=function(filter){$("#filter-modal").foundation("open"),typeaheads_loaded.then((()=>{new_filter_labels=filter.labels;let connectionTypeKeys=list_settings.post_type_settings.connection_types;connectionTypeKeys.push("location_grid"),new_filter_labels.forEach((label=>{selected_filters.append(`<span class="current-filter ${window.lodash.escape(label.field)}" data-id="${window.lodash.escape(label.id)}">${window.lodash.escape(label.name)}</span>`);let type=window.lodash.get(list_settings,`post_type_settings.fields.${label.field}.type`);"key_select"===type||"boolean"===type?$(`#filter-modal #${label.field}-options input[value="${label.id}"]`).prop("checked",!0):"date"===type?$(`#filter-modal #${label.field}-options #${label.id}`).datepicker("setDate",label.date):connectionTypeKeys.includes(label.field)?Typeahead[`.js-typeahead-${label.field}`].addMultiselectItemLayout({ID:label.id,name:label.name}):"multi_select"===type?Typeahead[`.js-typeahead-${label.field}`].addMultiselectItemLayout({key:label.id,value:label.name}):"user_select"===type&&Typeahead[`.js-typeahead-${label.field}`].addMultiselectItemLayout({name:label.name,ID:label.id})})),(filter.query.combine||[]).forEach((c=>{$(`#combine_${c}`).prop("checked",!0)})),$("#new-filter-name").val(filter.name),$("#confirm-filter-records").hide(),$("#save-filter-edits").data("filter-id",filter.ID).show()}))};function bulk_edit_count(){let bulk_edit_total_checked=$(".bulk_edit_checkbox:not(#bulk_edit_master) input:checked").length,bulk_edit_submit_button_text=$("#bulk_edit_submit_text");0==bulk_edit_total_checked?bulk_edit_submit_button_text.text(`Update ${list_settings.post_type}`):bulk_edit_submit_button_text.text(`Update ${bulk_edit_total_checked} ${list_settings.post_type}`)}function process(q,num,fn,done,update,share){let items=q.splice(0,num),count=items.length;if(count)for(let i=0;i<count;i++)fn(items[i],(function(){--count||process(q,num,fn,done,update,share)}),update,share);else done&&done()}function doEach(item,done,update,share){let promises=[];Object.keys(update).length&&promises.push(API.update_post(list_settings.post_type,item,update).catch((err=>{console.error(err)}))),share&&share.forEach((function(value){promises.push(API.add_shared(list_settings.post_type,item,value).catch((err=>{console.error(err)})))})),Promise.all(promises).then((function(){done()}))}function doDone(){$("#bulk_edit_submit-spinner").removeClass("active"),window.location.reload()}$("#save-filter-edits").on("click",(function(){let search_query=get_custom_filter_search_query(),filter_id=$("#save-filter-edits").data("filter-id"),filter=window.lodash.find(list_settings.filters.filters,{ID:filter_id});filter.name=$("#new-filter-name").val(),$(`.filter-list-name[data-filter="${filter_id}"]`).text(filter.name),filter.query=search_query,filter.labels=new_filter_labels,API.save_filters(list_settings.post_type,filter),get_records_for_current_filter()})),$("#filter-tabs").on("change.zf.tabs",(function(a,b){let field=$(b).data("field");$(".tabs-panel").removeClass("is-active"),$(`#${field}.tabs-panel`).addClass("is-active"),field&&Typeahead[`.js-typeahead-${field}`]&&Typeahead[`.js-typeahead-${field}`].adjustInputSize()})),$("#filter-modal .key_select_options input").on("change",(function(){let field_key=$(this).data("field"),option_id=$(this).val();if($(this).is(":checked")){let option_name=window.lodash.get(list_settings,`post_type_settings.fields.${field_key}.default`)[option_id].label,name=window.lodash.get(list_settings,`post_type_settings.fields.${field_key}.name`,field_key);new_filter_labels.push({id:$(this).val(),name:`${name}: ${option_name}`,field:field_key}),selected_filters.append(`<span class="current-filter ${window.lodash.escape(field_key)}" data-id="${window.lodash.escape(option_id)}">${window.lodash.escape(name)}:${window.lodash.escape(option_name)}</span>`)}else $(`.current-filter[data-id="${$(this).val()}"].${field_key}`).remove(),window.lodash.pullAllBy(new_filter_labels,[{id:option_id}],"id")})),$("#filter-modal .boolean_options input").on("change",(function(){let field_key=$(this).data("field"),option_id=$(this).val(),label=$(this).data("label");if($(this).is(":checked")){let field=window.lodash.get(list_settings,`post_type_settings.fields.${field_key}`);new_filter_labels.push({id:$(this).val(),name:`${field.name}: ${label}`,field:field_key}),selected_filters.append(`<span class="current-filter ${window.lodash.escape(field_key)}" data-id="${window.lodash.escape(option_id)}">${window.lodash.escape(field.name)}:${window.lodash.escape(label)}</span>`)}else $(`.current-filter[data-id="${$(this).val()}"].${field_key}`).remove(),window.lodash.pullAllBy(new_filter_labels,[{id:option_id}],"id")})),$("#filter-modal .dt_date_picker").datepicker({constrainInput:!1,dateFormat:"yy-mm-dd",onSelect:function(date){let id=$(this).data("field"),delimiter=$(this).data("delimit"),delimiter_label=list_settings.translations[`range_${delimiter}`],field_name=window.lodash.get(list_settings,`post_type_settings.fields.${id}.name`,id);window.lodash.pullAllBy(new_filter_labels,[{id:`${id}_${delimiter}`}],"id"),$(`.current-filter[data-id="${id}_${delimiter}"]`).remove(),new_filter_labels.push({id:`${id}_${delimiter}`,name:`${field_name} ${delimiter_label}: ${date}`,field:id,date:date}),selected_filters.append(`\n        <span class="current-filter ${id}_${delimiter}"\n              data-id="${id}_${delimiter}">\n                ${field_name} ${delimiter_label}:${date}\n        </span>\n      `)},changeMonth:!0,changeYear:!0}),$("#filter-modal .clear-date-picker").on("click",(function(){let id=$(this).data("for");$(`#filter-modal #${id}`).datepicker("setDate",null),window.lodash.pullAllBy(new_filter_labels,[{id:`${id}`}],"id"),$(`.current-filter[data-id="${id}"]`).remove()})),$("#confirm-filter-save").on("click",(function(){let filterName=$("#filter-name").val(),filter=window.lodash.find(custom_filters,{ID:filter_to_save});filter.name=window.lodash.escape(filterName),filter.tab="custom",filter.query&&(list_settings.filters.filters.push(filter),API.save_filters(list_settings.post_type,filter).then((()=>{$(`.custom-filters [class*="list-view ${filter_to_save}`).remove(),setup_filters(),"custom"!==$(".accordion-item.is-active ").data("id")&&$("#list-filter-tabs [data-id='custom'] a").click(),$(`input[name="view"][value="saved-filters"][data-id='${filter_to_save}']`).prop("checked",!0),get_records_for_current_filter(),$("#filter-name").val("")})).catch((err=>{console.error(err)})))})),$("#confirm-filter-delete").on("click",(function(){let filter=window.lodash.find(list_settings.filters.filters,{ID:filter_to_delete});!filter||!0!==filter.visible&&"1"!==filter.visible?API.delete_filter(list_settings.post_type,filter_to_delete).then((()=>{window.lodash.pullAllBy(list_settings.filters.filters,[{ID:filter_to_delete}],"ID"),setup_filters(),check_first_filter(),get_records_for_current_filter()})).catch((err=>{console.error(err)})):(filter.visible=!1,API.save_filters(list_settings.post_type,filter).then((()=>{window.lodash.pullAllBy(list_settings.filters.filters,[{ID:filter_to_delete}],"ID"),setup_filters(),$("#list-filter-tabs [data-id='custom'] a").click()})).catch((err=>{console.error(err)})))})),$("#advanced_search").on("click",(function(){$("#advanced_search_picker").toggle()})),$("#advanced_search_mobile").on("click",(function(){$("#advanced_search_picker_mobile").toggle()})),$("#advanced_search_reset").on("click",(function(){window.SHAREDFUNCTIONS.save_json_cookie("fields_to_search",[],list_settings.post_type),$("#advanced_search_picker ul li input:checked").each((function(index){$(this).prop("checked",!1)})),$("#search").click()})),$("#advanced_search_reset_mobile").on("click",(function(){window.SHAREDFUNCTIONS.save_json_cookie("fields_to_search",[],list_settings.post_type),$("#advanced_search_picker_mobile ul li input:checked").each((function(index){$(this).prop("checked",!1)})),$("#search-mobile").click()})),$("#save_advanced_search_choices").on("click",(function(){let fields_to_search=[];$("#advanced_search_picker ul li input:checked").each((function(index){fields_to_search.push($(this).val())})),window.SHAREDFUNCTIONS.save_json_cookie("fields_to_search",fields_to_search,list_settings.post_type),""!==$("#search-query").val()?$("#search").click():$("#advanced_search_picker").hide()})),$("#save_advanced_search_choices_mobile").on("click",(function(){let fields_to_search=[];$("#advanced_search_picker_mobile ul li input:checked").each((function(index){fields_to_search.push($(this).val())})),window.SHAREDFUNCTIONS.save_json_cookie("fields_to_search",fields_to_search,list_settings.post_type),""!==$("#search-query-mobile").val()?$("#search-mobile").click():$("#advanced_search_picker_mobile").hide()})),$("#search").on("click",(function(){let searchText=$("#search-query").val(),fieldsToSearch=[];$("#advanced_search_picker ul li input:checked").each((function(index){fieldsToSearch.push($(this).val())})),window.SHAREDFUNCTIONS.save_json_cookie("fields_to_search",fieldsToSearch,list_settings.post_type),fieldsToSearch.length>0?$(".advancedSearch-count").text(fieldsToSearch.length).css("display","inline-block"):$(".advancedSearch-count").text("fields_to_search.length").hide();let query={text:searchText};0!==fieldsToSearch.length&&(query.fields_to_search=fieldsToSearch),add_custom_filter(searchText,"search",query,[{id:"search",name:searchText,field:"search"}]),$("#advanced_search_picker").hide()})),$("#search-mobile").on("click",(function(){let searchText=window.lodash.escape($("#search-query-mobile").val()),fieldsToSearch=[];$("#advanced_search_picker_mobile ul li input:checked").each((function(index){fieldsToSearch.push($(this).val())})),window.SHAREDFUNCTIONS.save_json_cookie("fields_to_search",fieldsToSearch,list_settings.post_type),fieldsToSearch.length>0?$(".advancedSearch-count").text(fieldsToSearch.length).css("display","inline-block"):$(".advancedSearch-count").text("fields_to_search.length").hide();let query={text:searchText};0!==fieldsToSearch.length&&(query.fields_to_search=fieldsToSearch),add_custom_filter(searchText,"search",query,[{id:"search",name:searchText,field:"search"}]),$("#advanced_search_picker_mobile").hide()})),$(".search-input").on("keyup",(function(e){13===e.keyCode&&$("#search").trigger("click")})),$(".search-input-mobile").on("keyup",(function(e){13===e.keyCode&&$("#search-mobile").trigger("click")})),$("#open-search").on("click",(function(){$(".hideable-search").toggle()})),$("#bulk_edit_controls").on("click",(function(){$("#bulk_edit_picker").toggle(),$("#records-table").toggleClass("bulk_edit_on")})),$("#bulk_edit_seeMore").on("click",(function(){$("#bulk_more").toggle(),$("#bulk_edit_seeMore").children().toggle()})),$("#bulk_edit_master").on("click",(function(e){e.stopImmediatePropagation();let checked=$(this).children("input").is(":checked");$(".bulk_edit_checkbox input").each((function(){$(this).prop("checked",checked),bulk_edit_count()}))})),$("#bulk_edit_submit").on("click",(function(e){!function bulk_edit_submit(){$("#bulk_edit_submit-spinner").addClass("active");let sharePayload,allInputs=$("#bulk_edit_picker input, #bulk_edit_picker select, #bulk_edit_picker .button").not("#bulk_share"),multiSelectInputs=$("#bulk_edit_picker .dt_multi_select"),shareInput=$("#bulk_share"),updatePayload={};allInputs.each((function(){let inputData=$(this).data();$.each(inputData,(function(key,value){if(key.includes("bulk_key_")&&value){let field_key=key.replace("bulk_key_","");field_key&&(updatePayload[field_key]=value)}}))})),window.location_data&&(updatePayload.location_grid_meta=window.location_data.location_grid_meta);let multiSelectUpdatePayload={};multiSelectInputs.each((function(){let inputData=$(this).data();$.each(inputData,(function(key,value){if(key.includes("bulk_key_")&&value){let field_key=key.replace("bulk_key_","");multiSelectUpdatePayload[field_key]||(multiSelectUpdatePayload[field_key]={values:[]}),multiSelectUpdatePayload[field_key].values.push(value.values)}}))}));Object.keys(multiSelectUpdatePayload).forEach(((key,index)=>{console.log(`${key}: ${multiSelectUpdatePayload[key]}`),updatePayload[key]=multiSelectUpdatePayload[key]})),shareInput.each((function(){sharePayload=$(this).data("bulk_key_share")}));let queue=[];$(".bulk_edit_checkbox input").each((function(){if(this.checked&&"bulk_edit_master_checkbox"!==this.id){let postId=parseInt($(this).val());queue.push(postId)}})),process(queue,10,doEach,doDone,updatePayload,sharePayload)}()})),$("#bulk_edit_picker .update-needed").on("click",(function(e){$(this).is(":checked")&&$(this).data("bulk_key_requires_update",!0)})),$("#bulk_edit_picker select").on("change",(function(e){let field_key=this.id.replace("bulk_","");$(this).data(`bulk_key_${field_key}`,this.value)})),$("#bulk_edit_picker .select-button").on("click",(function(e){let field_key=$(this).data("field-key").replace("bulk_",""),optionKey=$(this).attr("id"),fieldValue={};fieldValue.values={value:optionKey},$(this).addClass("selected-select-button"),$(this).data(`bulk_key_${field_key}`,fieldValue)}));$(".js-typeahead-bulk_assigned_to");$.typeahead({input:".js-typeahead-bulk_assigned_to",minLength:0,maxItem:0,accent:!0,searchOnFocus:!0,source:TYPEAHEADS.typeaheadUserSource(),templateValue:"{{name}}",template:function(query,item){return`<div class="assigned-to-row" dir="auto">\n        <span>\n            <span class="avatar"><img style="vertical-align: text-bottom" src="{{avatar}}"/></span>\n            ${window.lodash.escape(item.name)}\n        </span>\n        ${item.status_color?`<span class="status-square" style="background-color: ${window.lodash.escape(item.status_color)};">&nbsp;</span>`:""}\n        ${item.update_needed&&item.update_needed>0?`<span>\n          <img style="height: 12px;" src="${window.lodash.escape(window.wpApiShare.template_dir)}/dt-assets/images/broken.svg"/>\n          <span style="font-size: 14px">${window.lodash.escape(item.update_needed)}</span>\n        </span>`:""}\n      </div>`},dynamic:!0,hint:!0,emptyTemplate:window.lodash.escape(window.wpApiShare.translations.no_records_found),callback:{onClick:function(node,a,item){node.data("bulk_key_assigned_to",`user-${item.ID}`)},onResult:function(node,query,result,resultCount){let text=TYPEAHEADS.typeaheadHelpText(resultCount,query,result);$("#bulk_assigned_to-result-container").html(text)},onHideLayout:function(){$(".bulk_assigned_to-result-container").html("")},onReady:function(){}}}),$.typeahead({input:"#bulk_share",minLength:0,maxItem:0,accent:!0,searchOnFocus:!0,source:TYPEAHEADS.typeaheadUserSource(),templateValue:"{{name}}",dynamic:!0,multiselect:{matchOn:["ID"],callback:{onCancel:function(node,item){$(node).removeData("bulk_key_bulk_share"),$("#share-result-container").html("")}}},callback:{onClick:function(node,a,item,event){let shareUserArray;shareUserArray=node.data("bulk_key_share")?node.data("bulk_key_share"):[],shareUserArray.push(item.ID),node.data("bulk_key_share",shareUserArray)},onResult:function(node,query,result,resultCount){if(query){let text=window.TYPEAHEADS.typeaheadHelpText(resultCount,query,result);$("#share-result-container").html(text)}},onHideLayout:function(){$("#share-result-container").html("")}}});window.list_settings.post_type_settings.fields;$("#bulk_edit_picker .dt_typeahead").each(((key,el)=>{let field_id=$(el).attr("id").replace("_connection","").replace("bulk_",""),element_id=$(el).attr("id").replace("_connection","");if("bulk_share"!==element_id){let listing_post_type=window.lodash.get(window.list_settings.post_type_settings.fields[field_id],"post_type","contacts");$.typeahead({input:`.js-typeahead-${element_id}`,minLength:0,accent:!0,maxItem:30,searchOnFocus:!0,template:window.TYPEAHEADS.contactListRowTemplate,source:window.TYPEAHEADS.typeaheadPostsSource(listing_post_type,{field_key:field_id}),display:"name",templateValue:"{{name}}",dynamic:!0,multiselect:{matchOn:["ID"],data:"",callback:{onCancel:function(node,item){$(node).removeData(`bulk_key_${field_id}`)}},href:window.wpApiShare.site_url+`/${listing_post_type}/{{ID}}`},callback:{onClick:function(node,a,item,event){let multiUserArray;multiUserArray=node.data(`bulk_key_${field_id}`)?node.data(`bulk_key_${field_id}`).values:[],multiUserArray.push({value:item.ID}),node.data(`bulk_key_${field_id}`,{values:multiUserArray}),this.addMultiselectItemLayout(item),event.preventDefault(),this.hideLayout(),this.resetInput()},onResult:function(node,query,result,resultCount){let text=TYPEAHEADS.typeaheadHelpText(resultCount,query,result);$(`#${element_id}-result-container`).html(text)},onHideLayout:function(event,query){query||$(`#${element_id}-result-container`).empty()},onShowLayout(){}}})}})),$("#bulk_edit_picker .dt_location_grid").each((()=>{let typeaheadTotals={};$.typeahead({input:".js-typeahead-location_grid",minLength:0,accent:!0,searchOnFocus:!0,maxItem:20,dropdownFilter:[{key:"group",value:"focus",template:window.lodash.escape(window.wpApiShare.translations.regions_of_focus),all:window.lodash.escape(window.wpApiShare.translations.all_locations)}],source:{focus:{display:"name",ajax:{url:window.wpApiShare.root+"dt/v1/mapping_module/search_location_grid_by_name",data:{s:"{{query}}",filter:function(){}},beforeSend:function(xhr){xhr.setRequestHeader("X-WP-Nonce",window.wpApiShare.nonce)},callback:{done:function(data){return void 0!==typeaheadTotals&&(typeaheadTotals.field=data.total),data.location_grid}}}}},display:"name",templateValue:"{{name}}",dynamic:!0,multiselect:{matchOn:["ID"],data:"",callback:{onCancel:function(node,item){$(node).removeData("bulk_key_location_grid")}}},callback:{onClick:function(node,a,item,event){node.data("bulk_key_location_grid",{values:[{value:item.ID}]})},onReady(){this.filters.dropdown={key:"group",value:"focus",template:window.lodash.escape(window.wpApiShare.translations.regions_of_focus)},this.container.removeClass("filter").find("."+this.options.selector.filterButton).html(window.lodash.escape(window.wpApiShare.translations.regions_of_focus))},onResult:function(node,query,result,resultCount){resultCount=typeaheadTotals.location_grid;let text=TYPEAHEADS.typeaheadHelpText(resultCount,query,result);$("#location_grid-result-container").html(text)},onHideLayout:function(){$("#location_grid-result-container").html("")}}})})),$("button.follow").on("click",(function(){let following=!("following"===$(this).data("value"));$(this).data("value",following?"following":""),$(this).html(following?"Unfollow":"Follow"),$(this).toggleClass("hollow");let follow={values:[{value:current_user_id,delete:!following}]},unfollow={values:[{value:current_user_id,delete:following}]};$(this).data("bulk_key_follow",follow),$(this).data("bulk_key_unfollow",unfollow)})),$("#bulk_edit_picker input.text-input").change((function(){const val=$(this).val();let field_key=this.id.replace("bulk_","");$(this).data(`bulk_key_${field_key}`,val)})),$("#bulk_edit_picker .dt_textarea").change((function(){const val=$(this).val();let field_key=this.id.replace("bulk_","");$(this).data(`bulk_key_${field_key}`,val)})),$("#bulk_edit_picker .dt_date_picker").datepicker({constrainInput:!1,dateFormat:"yy-mm-dd",onClose:function(date){if(document.querySelector("#group-details-edit-modal")&&document.querySelector("#group-details-edit-modal").contains(this));else{date=window.SHAREDFUNCTIONS.convertArabicToEnglishNumbers(date),$(this).val()||(date=" ");let formattedDate=moment.utc(date).unix(),field_key=this.id.replace("bulk_","");$(this).data(`bulk_key_${field_key}`,formattedDate)}},changeMonth:!0,changeYear:!0,yearRange:"1900:2050"}).each((function(){this.value&&moment.unix(this.value).isValid()&&(this.value=window.SHAREDFUNCTIONS.formatDate(this.value))})),$("#bulk_edit_picker .clear-date-button").click((function(){let input_id=this.dataset.inputid,field_key=this.id.replace("bulk_","");$(this).removeData(`bulk_key_${field_key}`),$(`#${input_id}`).val("")})),$("#bulk_edit_picker select.select-field").change((e=>{const val=$(e.currentTarget).val();"paused"===val&&$("#reason-paused-options").parent().toggle();let field_key=e.currentTarget.id.replace("bulk_","");$(e.currentTarget).data(`bulk_key_${field_key}`,val)})),$("#bulk_edit_picker input.number-input").on("blur",(function(){$(this).attr("id");const val=$(this).val();let field_key=this.id.replace("bulk_","");$(this).data(`bulk_key_${field_key}`,val)})),$("#bulk_edit_picker .dt_contenteditable").on("blur",(function(){$(this).attr("id");let val=$(this).html(),field_key=this.id.replace("bulk_","");$(this).data(`bulk_key_${field_key}`,val)}))}(window.jQuery,window.list_settings,window.Foundation);
//# sourceMappingURL=modular-list.min.js.map
