"use strict";function _defineProperty(obj,key,value){if(key in obj){Object.defineProperty(obj,key,{value:value,enumerable:true,configurable:true,writable:true});}else{obj[key]=value;}return obj;}/* global wpApiShare:false */_=_||window.lodash;// make sure lodash is defined so plugins like gutenberg don't break it.
jQuery(document).ready(function($){// Adds an active state to the top bar navigation
var ref="";if(wpApiShare&&wpApiShare.site_url){ref=window.location.href.replace(wpApiShare.site_url+'/',"");}else{ref=window.location.pathname;}var page=""+(ref.replace(wpApiShare.site_url,'').split('/')[0]+'');$("div.top-bar-left ul.menu [href^=\""+(wpApiShare.site_url+'/'+page)+"\"]").parent().addClass('active');var collapsed_tiles=window.SHAREDFUNCTIONS.get_json_cookie('collapsed_tiles');// expand and collapse tiles, only when a section chevron icon is clicked for that given tile.
$(".section-header .section-chevron").on("click",function(){var tile=$(this).closest('.bordered-box');tile.toggleClass("collapsed");var tile_id=tile.attr("id");if(tile_id&&tile_id.includes('-tile')){if(collapsed_tiles.includes(tile_id)){collapsed_tiles=window.lodash.pull(collapsed_tiles,tile_id);}else{collapsed_tiles.push(tile_id);}window.SHAREDFUNCTIONS.save_json_cookie('collapsed_tiles',collapsed_tiles,wpApiShare.post_type);}$('.grid').masonry('layout');});$(".bordered-box").each(function(index,item){var id=$(item).attr('id');if(id&&id.includes('-tile')&&collapsed_tiles.includes(id)){$(item).addClass('collapsed');}});});/**
 *
 * @param type: GET POST DELETE
 * @param url: users/get_users
 * @param data
 * @param base, when using a custom D.T endpoint that does not start with dt/v1
 * @returns {jQuery}
 */function makeRequest(type,url,data){var base=arguments.length>3&&arguments[3]!==undefined?arguments[3]:'dt/v1/';var options={type:type,contentType:'application/json; charset=utf-8',dataType:'json',url:url.startsWith('http')?url:""+wpApiShare.root+base+url,beforeSend:function beforeSend(xhr){xhr.setRequestHeader('X-WP-Nonce',wpApiShare.nonce);}};if(data){options.data=type==="GET"?data:JSON.stringify(data);}return jQuery.ajax(options);}function makeRequestOnPosts(type,url,data){var options={type:type,contentType:'application/json; charset=utf-8',dataType:'json',url:url.startsWith('http')?url:wpApiShare.root+"dt-posts/v2/"+url,beforeSend:function beforeSend(xhr){xhr.setRequestHeader('X-WP-Nonce',wpApiShare.nonce);}};if(data&&!window.lodash.isEmpty(data)){options.data=type==="GET"?data:JSON.stringify(data);}return jQuery.ajax(options);}window.API={get_post:function get_post(post_type,postId){return makeRequestOnPosts('GET',post_type+"/"+postId);},create_post:function create_post(post_type,fields){return makeRequestOnPosts('POST',""+post_type,fields);},update_post:function update_post(post_type,postId,postData){return makeRequestOnPosts('POST',post_type+"/"+postId,postData);},delete_post:function delete_post(post_type,postId){return makeRequestOnPosts('DELETE',post_type+"/"+postId);},post_comment:function post_comment(post_type,postId,comment){var comment_type=arguments.length>3&&arguments[3]!==undefined?arguments[3]:"comment";return makeRequestOnPosts('POST',post_type+"/"+postId+"/comments",{comment:comment,comment_type:comment_type});},delete_comment:function delete_comment(post_type,postId,comment_ID){return makeRequestOnPosts('DELETE',post_type+"/"+postId+"/comments/"+comment_ID);},update_comment:function update_comment(post_type,postId,comment_ID,comment_content){var commentType=arguments.length>4&&arguments[4]!==undefined?arguments[4]:"comment";return makeRequestOnPosts('POST',post_type+"/"+postId+"/comments/"+comment_ID,{comment:comment_content,comment_type:commentType});},get_comments:function get_comments(post_type,postId){return makeRequestOnPosts('GET',post_type+"/"+postId+"/comments");},get_activity:function get_activity(post_type,postId){return makeRequestOnPosts('GET',post_type+"/"+postId+"/activity");},get_single_activity:function get_single_activity(post_type,postId,activityId){return makeRequestOnPosts('GET',post_type+"/"+postId+"/activity/"+activityId);},get_shared:function get_shared(post_type,postId){return makeRequestOnPosts('GET',post_type+"/"+postId+"/shares");},add_shared:function add_shared(post_type,postId,userId){return makeRequestOnPosts('POST',post_type+"/"+postId+"/shares",{user_id:userId});},remove_shared:function remove_shared(post_type,postId,userId){return makeRequestOnPosts('DELETE',post_type+"/"+postId+"/shares",{user_id:userId});},save_field_api:function save_field_api(post_type,postId,postData){return makeRequestOnPosts('POST',post_type+"/"+postId,postData);},revert_activity:function revert_activity(post_type,postId,activityId){return makeRequestOnPosts('GET',post_type+"/"+postId+"/revert/"+activityId);},search_users:function search_users(query){return makeRequest('GET',"users/get_users?s="+query);},get_filters:function get_filters(){return makeRequest('GET','users/get_filters');},save_filters:function save_filters(post_type,filter){return makeRequest('POST','users/save_filters',{filter:filter,post_type:post_type});},delete_filter:function delete_filter(post_type,id){return makeRequest('DELETE','users/save_filters',{id:id,post_type:post_type});},get_duplicates_on_post:function get_duplicates_on_post(post_type,postId,args){return makeRequestOnPosts('GET',post_type+"/"+postId+"/all_duplicates",args);},create_user:function create_user(user){return makeRequest('POST','users/create',user);},transfer_contact:function transfer_contact(contactId,siteId){return makeRequestOnPosts('POST','contacts/transfer',{contact_id:contactId,site_post_id:siteId});}};function handleAjaxError(err){if(window.lodash.get(err,"statusText")!=="abortPromise"&&err.responseText){console.trace("error");console.log(err);// jQuery("#errors").append(err.responseText)
}}jQuery(document).ajaxComplete(function(event,xhr,settings){if(xhr&&xhr.responseJSON){// Event that a contact record has been updated
if(xhr.responseJSON.ID&&xhr.responseJSON.post_type){var request=settings.data?JSON.parse(settings.data):{};$(document).trigger("dt_record_updated",[xhr.responseJSON,request]);}}if(window.lodash.get(xhr,'responseJSON.data.status')===401){window.location.reload();}}).ajaxError(function(event,xhr){handleAjaxError(xhr);});jQuery(document).on('click','.help-button',function(){jQuery('#help-modal').foundation('open');var section=jQuery(this).data("section");jQuery(".help-section").hide();jQuery("#"+section).show();});jQuery(document).on('click','.help-button-tile',function(){jQuery('#help-modal-field').foundation('open');var section=jQuery(this).data("tile");jQuery(".help-section").hide();var tile=window.wpApiShare.tiles[section];if(tile&&window.post_type_fields){if(tile.label){$('#help-modal-field-title').html(tile.label);}if(tile.description){$('#help-modal-field-description').html(tile.description);}var html="";window.lodash.forOwn(window.post_type_fields,function(field,field_key){if(field.tile===section&&(field.description||window.lodash.isObject(field.default))&&!field.hidden){html+="<h2>"+window.lodash.escape(field.name)+"</h2>";html+="<p>"+window.lodash.escape(field.description)+"</p>";if(window.lodash.isObject(field.default)){var list_html="<ul>";window.lodash.forOwn(field.default,function(field_options,field_key){list_html+="<li><strong>"+window.lodash.escape(field_options.label)+"</strong> "+window.lodash.escape(!field_options.description?'':'- '+field_options.description)+"</li>";});list_html+="</ul>";html+=list_html;}}});$('#help-modal-field-body').html(html);}jQuery("#"+section).show();});jQuery(document).on('click','.help-button-field',function(){jQuery('#help-modal-field').foundation('open');var section=jQuery(this).data("section").replace('-help-text','');jQuery(".help-section").hide();if(window.post_type_fields&&window.post_type_fields[section]){var field=window.post_type_fields[section];if(field.description){$('#help-modal-field-title').html(field.name);$('#help-modal-field-description').html(field.description);}if(window.lodash.isObject(field.default)){var html="<ul>";window.lodash.forOwn(field.default,function(field_options,field_key){html+="<li><strong>"+window.lodash.escape(field_options.label)+"</strong> "+window.lodash.escape(!field_options.description?'':'- '+field_options.description)+"</li>";});html+="</ul>";$('#help-modal-field-body').html(html);}}jQuery("#"+section).show();});window.TYPEAHEADS={typeaheadSource:function typeaheadSource(field,url){return{contacts:{display:["name","ID"],template:"<span>{{name}}</span>",ajax:{url:wpApiShare.root+url,data:{s:"{{query}}"},beforeSend:function beforeSend(xhr){xhr.setRequestHeader('X-WP-Nonce',wpApiShare.nonce);},callback:{done:function done(data){if(typeof typeaheadTotals!=="undefined"){typeaheadTotals.field=data.total;}return data.posts;}}}}};},typeaheadPeopleGroupSource:function typeaheadPeopleGroupSource(field,url){return{contacts:{template:"<span>{{label}}</span>",ajax:{url:wpApiShare.root+url,data:{s:"{{query}}"},beforeSend:function beforeSend(xhr){xhr.setRequestHeader('X-WP-Nonce',wpApiShare.nonce);},callback:{done:function done(data){if(typeof typeaheadTotals!=="undefined"){typeaheadTotals.field=data.total;}return data.posts;}}}}};},typeaheadUserSource:function typeaheadUserSource(field,ur){return{users:{display:["name","user"],ajax:{url:wpApiShare.root+'dt/v1/users/get_users',data:{s:"{{query}}"},beforeSend:function beforeSend(xhr){xhr.setRequestHeader('X-WP-Nonce',wpApiShare.nonce);},callback:{done:function done(data){return data.posts||data;}}}}};},typeaheadContactsSource:function typeaheadContactsSource(){return{contacts:{display:["name","ID"],ajax:{url:wpApiShare.root+'dt-posts/v2/contacts/compact',data:{s:"{{query}}"},beforeSend:function beforeSend(xhr){xhr.setRequestHeader('X-WP-Nonce',wpApiShare.nonce);},callback:{done:function done(data){return data.posts;}}}}};},typeaheadPostsSource:function typeaheadPostsSource(post_type){var args=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};return{contacts:{display:["name","ID"],ajax:{url:wpApiShare.root+("dt-posts/v2/"+post_type+"/compact"),data:Object.assign({s:"{{query}}"},args),beforeSend:function beforeSend(xhr){xhr.setRequestHeader('X-WP-Nonce',wpApiShare.nonce);},callback:{done:function done(data){return data.posts;}}}}};},typeaheadHelpText:function typeaheadHelpText(resultCount,query,result){var text="";if(result.length>0&&query){text=wpApiShare.translations.showing_x_items_matching.replace('%1$s',"<strong>"+window.lodash.escape(result.length)+"</strong>").replace('%2$s',"<strong>"+window.lodash.escape(query)+"</strong>");}else if(result.length>0){text=wpApiShare.translations.showing_x_items.replace('%s',"<strong>"+window.lodash.escape(result.length)+"</strong>");}else{text=wpApiShare.translations.no_records_found.replace('"{{query}}"',"<strong>"+window.lodash.escape(query)+"</strong>");}return text;},contactListRowTemplate:function contactListRowTemplate(query,item){var img=item.user?"<img src=\""+wpApiShare.template_dir+"/dt-assets/images/profile.svg\">":'';var statusStyle=item.status==="closed"?'style="color:gray"':'';return"<span dir=\"auto\" "+statusStyle+">\n      <span class=\"typeahead-user-row\" style=\"width:20px\">"+img+"</span>\n      "+window.lodash.escape(item.name)+"\n      <span dir=\"auto\">(#"+window.lodash.escape(item.ID)+")</span>\n    </span>";},share:function share(post_type,id,v2){return $.typeahead({input:'.js-typeahead-share',minLength:0,maxItem:0,accent:true,searchOnFocus:true,source:this.typeaheadSource('share','dt/v1/users/get_users'),display:"name",templateValue:"{{name}}",dynamic:true,multiselect:{matchOn:["ID"],data:function data(){var deferred=$.Deferred();return window.API.get_shared(post_type,id).then(function(sharedResult){return deferred.resolve(sharedResult.map(function(g){return{ID:g.user_id,name:g.display_name};}));});},callback:{onCancel:function onCancel(node,item){$('#share-result-container').html("");window.API.remove_shared(post_type,id,item.ID).catch(function(err){Typeahead['.js-typeahead-share'].addMultiselectItemLayout({ID:item.ID,name:item.name});$('#share-result-container').html(window.lodash.get(err,"responseJSON.message"));});}}},callback:{onClick:function onClick(node,a,item,event){window.API.add_shared(post_type,id,item.ID);},onResult:function onResult(node,query,result,resultCount){if(query){var text=window.TYPEAHEADS.typeaheadHelpText(resultCount,query,result);$('#share-result-container').html(text);}},onHideLayout:function onHideLayout(){$('#share-result-container').html("");}}});},defaultContactTypeahead:function defaultContactTypeahead(){return{minLength:0,accent:true,searchOnFocus:true,maxItem:20,template:this.contactListRowTemplate,source:this.typeaheadContactsSource(),display:"name",templateValue:"{{name}}",dynamic:true};}};window.SHAREDFUNCTIONS={getCookie:function getCookie(cname){var name=cname+"=";var decodedCookie=decodeURIComponent(document.cookie);var ca=decodedCookie.split(';');for(var i=0;i<ca.length;i++){var c=ca[i];while(c.charAt(0)==' '){c=c.substring(1);}if(c.indexOf(name)==0){return c.substring(name.length,c.length);}}return"";},get_json_cookie:function get_json_cookie(cname){var default_val=arguments.length>1&&arguments[1]!==undefined?arguments[1]:[];var cookie=this.getCookie(cname);try{default_val=JSON.parse(cookie);}catch(e){}return default_val;},save_json_cookie:function save_json_cookie(cname,json){var path=arguments.length>2&&arguments[2]!==undefined?arguments[2]:'';if(path){path=window.location.pathname.split(path)[0]+path;path=path.replace(/^\/?([^\/]+(?:\/[^\/]+)*)\/?$/,'/$1');// add leading and remove trailing slashes
}document.cookie=cname+"="+JSON.stringify(json)+";path="+path;},formatDate:function formatDate(date){var with_time=arguments.length>1&&arguments[1]!==undefined?arguments[1]:false;var langcode=document.querySelector('html').getAttribute('lang')?document.querySelector('html').getAttribute('lang').replace('_','-'):"en";// get the language attribute from the HTML or default to english if it doesn't exists.
if(langcode==="fa-IR"){//This is a check so that we use the gergorian (Western) calendar if the users locale is Farsi. This is the calendar used primarily by Farsi speakers outside of Iran, and is easily understood by those inside.
langcode=langcode+"-u-ca-gregory";}var options={year:'numeric',month:'long',day:'numeric'};if(with_time){options.hour='numeric';options.minute='numeric';}else{options.timeZone='UTC';}var formattedDate=new Intl.DateTimeFormat(langcode,options).format(date*1000);return formattedDate;},convertArabicToEnglishNumbers:function convertArabicToEnglishNumbers(string){return string.replace(/[\u0660-\u0669]/g,function(c){return c.charCodeAt(0)-0x0660;}).replace(/[\u06f0-\u06f9]/g,function(c){return c.charCodeAt(0)-0x06f0;});},get_url_param:function get_url_param(name){var results=new RegExp('[\?&]'+name+'=([^&#]*)').exec(window.location.search);return results!==null?results[1]||0:false;}};window.METRICS={setupDatePicker:function setupDatePicker(endpoint_url,callback,startDate,endDate){var _ranges;$('.date_range_picker').daterangepicker({"showDropdowns":true,ranges:(_ranges={'All time':[moment(0),moment().endOf('year')]},_defineProperty(_ranges,moment().format("MMMM YYYY"),[moment().startOf('month'),moment().endOf('month')]),_defineProperty(_ranges,moment().subtract(1,'month').format("MMMM YYYY"),[moment().subtract(1,'month').startOf('month'),moment().subtract(1,'month').endOf('month')]),_defineProperty(_ranges,moment().format("YYYY"),[moment().startOf('year'),moment().endOf('year')]),_defineProperty(_ranges,moment().subtract(1,'year').format("YYYY"),[moment().subtract(1,'year').startOf('year'),moment().subtract(1,'year').endOf('year')]),_defineProperty(_ranges,moment().subtract(2,'year').format("YYYY"),[moment().subtract(2,'year').startOf('year'),moment().subtract(2,'year').endOf('year')]),_ranges),"linkedCalendars":false,locale:{format:'YYYY-MM-DD'},"startDate":startDate||moment(0),"endDate":endDate||moment().endOf('year').format('YYYY-MM-DD')},function(start,end,label){$(".loading-spinner").addClass("active");jQuery.ajax({type:"GET",contentType:"application/json; charset=utf-8",dataType:"json",url:endpoint_url+"?start="+start.format('YYYY-MM-DD')+"&end="+end.format('YYYY-MM-DD'),beforeSend:function beforeSend(xhr){xhr.setRequestHeader('X-WP-Nonce',wpApiShare.nonce);}}).done(function(data){$(".loading-spinner").removeClass("active");if(label==="Custom Range"){label=start.format('MMMM D, YYYY')+' - '+end.format('MMMM D, YYYY');}callback(data,label,start,end);}).fail(function(err){console.log("error");console.log(err);// jQuery("#errors").append(err.responseText)
});// console.log('New date range selected: ' + start.format('YYYY-MM-DD') + ' to ' + end.format('YYYY-MM-DD') + ' (predefined range: ' + label + ')');
});}// nonce timeout fix
// every 5 minutes will check if nonce timed out
// if it did then it will redirect to login
};window.fiveMinuteTimer=setInterval(function(){//check if timed out
get_new_notification_count().fail(function(x){window.location.reload();});},300000);//300000 = five minutes